<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Smash Tennis: World Tour</title>
    <style>
        :root {
            --ui-bg: rgba(15, 23, 42, 0.95);
            --accent: #facc15;
            --danger: #ef4444;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #0f172a;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        canvas {
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            cursor: none;
        }

        /* --- UI OVERLAYS --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--ui-bg);
            z-index: 10;
            transition: opacity 0.3s, backdrop-filter 0.3s;
            backdrop-filter: blur(5px);
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 5rem;
            margin: 0;
            text-transform: uppercase;
            font-style: italic;
            letter-spacing: -2px;
            background: linear-gradient(to right, #facc15, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 4px 20px rgba(250, 204, 21, 0.3);
            text-align: center;
            line-height: 0.9;
        }

        h2 {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 40px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            padding: 20px 60px;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
            cursor: pointer;
            border-radius: 8px;
            transform: skew(-10deg);
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .btn:hover {
            transform: skew(-10deg) translateY(-2px);
            filter: brightness(1.2);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: skew(-10deg) translateY(2px);
        }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 60px;
            box-sizing: border-box;
            font-size: 4rem;
            font-weight: 900;
            pointer-events: none;
            z-index: 5;
            text-shadow: 4px 4px 0 #000;
        }

        #powerup-indicator {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            font-weight: 900;
            font-style: italic;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.8), 3px 3px 0 #000;
            opacity: 0;
            transition: transform 0.2s, opacity 0.3s;
            text-align: center;
        }

        /* --- BRACKET/LEVEL CARDS --- */
        .level-card {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #334155;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            min-width: 400px;
        }

        .level-badge {
            background: #5900ff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 15px;
        }

        .opponent-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .dot {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            box-shadow: 0 0 10px currentColor;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="hud" class="hidden">
        <div id="score-player" style="color: #60a5fa">0</div>
        <div id="score-ai" style="color: #f87171">0</div>
    </div>
    <div id="powerup-indicator">POWER UP!</div>

    <div id="menu-screen" class="overlay">
        <h1>Super Smash<br>Tennis</h1>
        <h2>World Tour Edition</h2>
        <button class="btn" onclick="startGame()">Start Campaign</button>
        <div style="margin-top: 30px; color: #64748b; font-size: 0.9rem;">
            Use Mouse/Touch to Move<br>Defeat 10 Opponents to Win
        </div>
    </div>

    <div id="bracket-screen" class="overlay hidden">
        <div class="level-card">
            <div class="level-badge" id="level-badge">Round 1</div>
            <h2 id="court-name" style="margin: 0; color: #fff;">Grass Court</h2>
            
            <div class="opponent-preview">
                <span style="font-size: 1.2rem; color: #64748b;">VS</span>
                <div id="opp-dot" class="dot"></div>
                <span id="opp-name">Opponent Name</span>
            </div>
            
            <p id="opp-desc" style="color: #cbd5e1; font-style: italic;">Description text.</p>
            
            <div class="stats-grid">
                <div>SPEED: <span id="stat-speed" style="color: white;">Low</span></div>
                <div>SKILL: <span id="stat-skill" style="color: white;">Rookie</span></div>
            </div>

            <button class="btn" onclick="startMatch()">PLAY MATCH</button>
        </div>
    </div>

    <div id="gameover-screen" class="overlay hidden">
        <h1 id="game-result">VICTORY</h1>
        <h2 id="game-message">Message</h2>
        <button class="btn" onclick="resetGame()">Main Menu</button>
    </div>
</div>

<script>
    /**
     * SUPER SMASH TENNIS - 10 LEVEL UPDATE
     */

    // --- Configuration ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const screens = {
        menu: document.getElementById('menu-screen'),
        bracket: document.getElementById('bracket-screen'),
        gameover: document.getElementById('gameover-screen'),
        hud: document.getElementById('hud')
    };

    const ui = {
        scoreP: document.getElementById('score-player'),
        scoreAi: document.getElementById('score-ai'),
        lvlBadge: document.getElementById('level-badge'),
        courtName: document.getElementById('court-name'),
        oppName: document.getElementById('opp-name'),
        oppDesc: document.getElementById('opp-desc'),
        oppDot: document.getElementById('opp-dot'),
        statSpeed: document.getElementById('stat-speed'),
        statSkill: document.getElementById('stat-skill'),
        powerInd: document.getElementById('powerup-indicator')
    };

    const CONSTANTS = {
        WIN_SCORE: 5,
        PADDLE_W: 18,
        PADDLE_H: 80,
        BALL_SIZE: 12,
        GRAVITY: 0, // Top down, no gravity
    };

    // --- Content Data ---

    const THEMES = {
        GRASS:  { name: "Grass Court", bg: "#14532d", line: "rgba(255,255,255,0.4)", accent: "#22c55e" },
        CLAY:   { name: "Clay Court",  bg: "#7c2d12", line: "rgba(255,255,255,0.5)", accent: "#ea580c" },
        HARD:   { name: "Hard Court",  bg: "#1e3a8a", line: "rgba(255,255,255,0.4)", accent: "#3b82f6" },
        CYBER:  { name: "Cyber Arena", bg: "#020617", line: "rgba(34, 211, 238, 0.3)", accent: "#0891b2" },
        FINAL:  { name: "The Core",    bg: "#270505", line: "rgba(239, 68, 68, 0.4)", accent: "#991b1b" }
    };

    const OPPONENTS = [
        // ROUND 1-3: GRASS (The Rookies)
        { name: "BALZE",   color: "#a3e635", speed: 4.0, skill: 0.1, theme: THEMES.GRASS, desc: "Just learned how to hold the paddle." },
        { name: "winer dan",   color: "#facc15", speed: 5.5, skill: 0.2, theme: THEMES.GRASS, desc: "Pretty fast, but makes mistakes." },
        { name: "broke dan", color: "#166534", speed: 6.5, skill: 0.3, theme: THEMES.GRASS, desc: "Respect the fundamentals." },
        
        // ROUND 4-6: CLAY (The Pros)
        { name: "thug Dan",    color: "#fb923c", speed: 7.5, skill: 0.4, theme: THEMES.CLAY, desc: "Loves the slow bounce of clay." },
        { name: "eddie",   color: "#c2410c", speed: 8.5, skill: 0.5, theme: THEMES.CLAY, desc: "Tricky angles are his specialty." },
        { name: "banna dan",   color: "#78350f", speed: 9.5, skill: 0.6, theme: THEMES.CLAY, desc: "She never gets tired." },
        
        // ROUND 7-9: HARD/CYBER (The Masters)
        { name: "donkey kong",  color: "#38bdf8", speed: 11.0, skill: 0.8, theme: THEMES.HARD, desc: "Calculates physics in real-time." },
        { name: "poop dan",   color: "#d946ef", speed: 13.0, skill: 0.85, theme: THEMES.CYBER, desc: "Teleports... practically." },
        { name: "khoolaid dan",       color: "#94a3b8", speed: 15.0, skill: 0.9, theme: THEMES.CYBER, desc: "A perfect mirror of your style." },

        // ROUND 10: FINAL BOSS
        { name: "TROYDAN",     color: "#ef4444", speed: 18.0, skill: 0.98, theme: THEMES.FINAL, desc: "THE FINAL TEST." }
    ];

    // --- Game State ---
    let state = {
        screen: 'MENU', 
        level: 0,
        pScore: 0,
        aiScore: 0,
        particles: [],
        powerups: [],
        activeEffect: null, // { type, target, timer }
        shake: 0,
        paused: false
    };

    // Entities
    const player = { x: 0, y: 0, w: CONSTANTS.PADDLE_W, h: CONSTANTS.PADDLE_H, color: '#60a5fa', baseColor: '#60a5fa' };
    const ai     = { x: 0, y: 0, w: CONSTANTS.PADDLE_W, h: CONSTANTS.PADDLE_H, color: '#f87171', baseColor: '#f87171', targetY: 0 };
    const ball   = { x: 0, y: 0, vx: 0, vy: 0, speed: 0, baseSpeed: 9, isFire: false };

    // --- Input ---
    let mouseY = 0;
    const updateMouse = (y) => {
        const rect = canvas.getBoundingClientRect();
        mouseY = y - rect.top;
    };
    canvas.addEventListener('mousemove', e => updateMouse(e.clientY));
    canvas.addEventListener('touchmove', e => { e.preventDefault(); updateMouse(e.touches[0].clientY); }, { passive: false });

    // --- Core Logic ---

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(state.screen === 'PLAYING') resetPositions();
    }
    window.addEventListener('resize', resize);
    resize();

    function startGame() {
        state.level = 0;
        showLevelScreen();
    }

    function showLevelScreen() {
        state.screen = 'BRACKET';
        const opp = OPPONENTS[state.level];
        
        // Update UI
        screens.menu.classList.add('hidden');
        screens.gameover.classList.add('hidden');
        screens.bracket.classList.remove('hidden');
        screens.hud.classList.add('hidden');

        ui.lvlBadge.textContent = state.level === 9 ? "FINAL BOSS" : `LEVEL ${state.level + 1}`;
        ui.courtName.textContent = opp.theme.name;
        ui.courtName.style.color = opp.theme.accent;
        ui.oppName.textContent = opp.name;
        ui.oppDesc.textContent = opp.desc;
        ui.oppDot.style.backgroundColor = opp.color;
        
        ui.statSpeed.textContent = opp.speed < 6 ? "Normal" : opp.speed < 10 ? "Fast" : "Insane";
        ui.statSkill.textContent = (opp.skill * 100).toFixed(0) + "%";
    }

    function startMatch() {
        state.screen = 'PLAYING';
        state.pScore = 0;
        state.aiScore = 0;
        state.powerups = [];
        state.particles = [];
        clearEffects();

        screens.bracket.classList.add('hidden');
        screens.hud.classList.remove('hidden');

        ai.baseColor = OPPONENTS[state.level].color;
        
        updateScore();
        resetPositions();
        launchBall();
        requestAnimationFrame(gameLoop);
    }

    function resetPositions() {
        player.x = 30;
        player.y = canvas.height/2 - player.h/2;
        
        ai.x = canvas.width - 30 - ai.w;
        ai.y = canvas.height/2 - ai.h/2;

        ball.x = canvas.width/2;
        ball.y = canvas.height/2;
        ball.vx = 0;
        ball.vy = 0;
        ball.isFire = false;
    }

    function launchBall() {
        ball.x = canvas.width/2;
        ball.y = canvas.height/2;
        const dir = Math.random() > 0.5 ? 1 : -1;
        ball.speed = ball.baseSpeed + (state.level * 0.5); // Gets faster every level
        ball.vx = dir * ball.speed;
        ball.vy = (Math.random() * 6) - 3;
        ball.isFire = false;
    }

    // --- Power Up System ---

    const POWER_TYPES = ['BIG', 'FAST', 'FIRE', 'SHRINK', 'gameeeeeebreaking'];

    function spawnPowerup() {
        // Chance based on level intensity
        if (state.powerups.length === 0 && Math.random() < 0.003) {
            const type = POWER_TYPES[Math.floor(Math.random() * POWER_TYPES.length)];
            const margin = 150;
            state.powerups.push({
                x: margin + Math.random() * (canvas.width - margin*2),
                y: margin + Math.random() * (canvas.height - margin*2),
                size: 35,
                type: type,
                angle: 0
            });
        }
    }

    function applyEffect(type, owner) {
        // Owner is WHO hit the ball last (Player or AI)
        // Target is the opponent of the owner
        const target = owner === 'player' ? 'ai' : 'player';
        
        clearEffects(); // Remove old effects

        let msg = "";
        let duration = 600; // 10s default

        if (type === 'BIG') {
            msg = "GIGA PADDLE";
            if(owner === 'player') player.h = CONSTANTS.PADDLE_H * 2;
            else ai.h = CONSTANTS.PADDLE_H * 2;
            
        } else if (type === 'FAST') {
            msg = "SPEED BOOST";
            state.activeEffect = { type: 'FAST', target: owner, timer: duration };

        } else if (type === 'FIRE') {
            msg = "FIREBALL!";
            ball.isFire = true;
            ball.speed *= 1.6;
            ball.vx *= 1.6;
            ball.vy *= 1.6;
            state.shake = 15;

        } else if (type === 'SHRINK') {
            msg = "SHRINK RAY";
            if(target === 'player') player.h = CONSTANTS.PADDLE_H * 0.5;
            else ai.h = CONSTANTS.PADDLE_H * 0.5;
            state.activeEffect = { type: 'SHRINK', target: target, timer: duration };

        } else if (type === 'FREEZE') {
            msg = "FROZEN!";
            // Freeze target
            state.activeEffect = { type: 'FREEZE', target: target, timer: 700 }; // 2 seconds only
        }

        // UI Feedback
        ui.powerInd.textContent = msg;
        ui.powerInd.style.opacity = '1';
        ui.powerInd.style.transform = 'translate(-50%, -20px) scale(1.2)';
        
        setTimeout(() => {
            ui.powerInd.style.opacity = '0';
            ui.powerInd.style.transform = 'translate(-50%, 0) scale(1)';
        }, 1500);
    }

    function clearEffects() {
        player.h = CONSTANTS.PADDLE_H;
        ai.h = CONSTANTS.PADDLE_H;
        player.color = player.baseColor;
        ai.color = ai.baseColor;
        ball.isFire = false;
        state.activeEffect = null;
    }

    // --- Update Loop ---

    function update() {
        if(state.shake > 0) state.shake--;

        // 1. Effects Timer
        if (state.activeEffect) {
            state.activeEffect.timer--;
            // Visuals for status effects
            const t = state.activeEffect.target === 'player' ? player : ai;
            if (state.activeEffect.type === 'FREEZE') t.color = '#a5f3fc'; // Cyan
            if (state.activeEffect.type === 'SHRINK') t.color = '#d8b4fe'; // Purple
            
            if (state.activeEffect.timer <= 0) clearEffects();
        }

        // 2. Player Move
        let pCanMove = true;
        if (state.activeEffect?.type === 'FREEZE' && state.activeEffect.target === 'player') pCanMove = false;
        
        if (pCanMove) {
            let targetY = mouseY - player.h/2;
            let speed = 0.2; // Smoothness
            if (state.activeEffect?.type === 'FAST' && state.activeEffect.target === 'player') speed = 0.45;
            player.y += (targetY - player.y) * speed;
            player.y = Math.max(0, Math.min(canvas.height - player.h, player.y));
        }

        // 3. AI Move
        let aiCanMove = true;
        if (state.activeEffect?.type === 'FREEZE' && state.activeEffect.target === 'ai') aiCanMove = false;

        if (aiCanMove) {
            const oppData = OPPONENTS[state.level];
            let aiCenter = ai.y + ai.h/2;
            let target = ball.y;

            // Prediction logic for higher levels
            if (ball.vx > 0) {
                // If ball coming towards AI
                // Add "Mistake" jitter based on skill (1.0 skill = 0 jitter)
                let errorMargin = (1 - oppData.skill) * 150; 
                target = ball.y + (Math.sin(Date.now() * 0.01) * errorMargin);
            } else {
                // Return to center when waiting
                target = canvas.height/2;
            }

            // AI Speed
            let maxSpeed = oppData.speed;
            if (state.activeEffect?.type === 'FAST' && state.activeEffect.target === 'ai') maxSpeed *= 1.5;

            if (aiCenter < target - 10) ai.y += maxSpeed;
            else if (aiCenter > target + 10) ai.y -= maxSpeed;

            ai.y = Math.max(0, Math.min(canvas.height - ai.h, ai.y));
        }

        // 4. Ball Physics
        ball.x += ball.vx;
        ball.y += ball.vy;

        // Walls
        if (ball.y <= 0 || ball.y >= canvas.height - CONSTANTS.BALL_SIZE) {
            ball.vy = -ball.vy;
            createParticles(ball.x, ball.y, '#fff', 5);
        }

        // Paddles
        checkPaddleCollision(player, true);
        checkPaddleCollision(ai, false);

        // Powerups
        for (let i = state.powerups.length - 1; i >= 0; i--) {
            let p = state.powerups[i];
            p.angle += 0.05; // Rotate animation
            if (checkRectCollide(ball.x, ball.y, CONSTANTS.BALL_SIZE, CONSTANTS.BALL_SIZE, p.x, p.y, p.size, p.size)) {
                // Who gets it? Last hitter. If ball moving right -> Player hit last.
                let owner = ball.vx > 0 ? 'player' : 'ai';
                applyEffect(p.type, owner);
                state.powerups.splice(i, 1);
                createParticles(p.x, p.y, '#fff', 15);
            }
        }
        spawnPowerup();

        // Scoring
        if (ball.x < -20) {
            state.aiScore++;
            createParticles(0, ball.y, '#ef4444', 30);
            state.shake = 20;
            resetRound();
        } else if (ball.x > canvas.width + 20) {
            state.pScore++;
            createParticles(canvas.width, ball.y, '#22c55e', 30);
            state.shake = 20;
            resetRound();
        }
    }

    function checkPaddleCollision(p, isPlayer) {
        if (checkRectCollide(ball.x, ball.y, CONSTANTS.BALL_SIZE, CONSTANTS.BALL_SIZE, p.x, p.y, p.w, p.h)) {
            
            // Calc angle
            let hitPoint = (ball.y + CONSTANTS.BALL_SIZE/2) - (p.y + p.h/2);
            hitPoint = hitPoint / (p.h/2); // -1 to 1
            let angle = hitPoint * (Math.PI/4); // 45deg max

            let dir = isPlayer ? 1 : -1;
            
            // Fireball break?
            if(ball.isFire) {
                // If player catches AI fireball, reset it
                ball.isFire = false;
                ball.speed = ball.speed / 1.6;
            }

            ball.speed += 0.5; // Acceleration
            // Cap speed
            if(ball.speed > 25) ball.speed = 25;

            ball.vx = dir * ball.speed * Math.cos(angle);
            ball.vy = ball.speed * Math.sin(angle);
            
            // Push ball out of paddle to prevent sticking
            ball.x += (dir * 5);

            createParticles(ball.x, ball.y, p.color, 8);
            state.shake = 4;
        }
    }

    function checkRectCollide(x1, y1, w1, h1, x2, y2, w2, h2) {
        return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
    }

    function resetRound() {
        updateScore();
        if (state.pScore >= CONSTANTS.WIN_SCORE) {
            endMatch(true);
        } else if (state.aiScore >= CONSTANTS.WIN_SCORE) {
            endMatch(false);
        } else {
            resetPositions();
            launchBall();
        }
    }

    function updateScore() {
        ui.scoreP.textContent = state.pScore;
        ui.scoreAi.textContent = state.aiScore;
    }

    function endMatch(win) {
        if (win) {
            state.level++;
            if (state.level >= OPPONENTS.length) {
                screens.gameover.classList.remove('hidden');
                screens.hud.classList.add('hidden');
                document.getElementById('game-result').textContent = "WORLD CHAMPION!";
                document.getElementById('game-result').style.color = "#facc15";
                document.getElementById('game-message').textContent = "You defeated the God of Tennis.";
            } else {
                showLevelScreen();
            }
        } else {
            screens.gameover.classList.remove('hidden');
            screens.hud.classList.add('hidden');
            document.getElementById('game-result').textContent = "DEFEATED";
            document.getElementById('game-result').style.color = "#ef4444";
            document.getElementById('game-message').textContent = `Stopped at Level ${state.level + 1}`;
        }
    }

    function resetGame() {
        state.screen = 'MENU';
        screens.gameover.classList.add('hidden');
        screens.menu.classList.remove('hidden');
    }

    // --- Drawing ---

    function draw() {
        const theme = OPPONENTS[state.level]?.theme || THEMES.GRASS;

        // Background
        ctx.fillStyle = theme.bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Shake transform
        ctx.save();
        if (state.shake > 0) {
            ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake);
        }

        // Court Lines
        ctx.strokeStyle = theme.line;
        ctx.lineWidth = 4;
        ctx.beginPath();
        // Center Line
        ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height);
        // Circle
        ctx.moveTo(canvas.width/2 + 50, canvas.height/2);
        ctx.arc(canvas.width/2, canvas.height/2, 50, 0, Math.PI*2);
        // Service boxes
        ctx.rect(canvas.width * 0.2, canvas.height * 0.1, canvas.width * 0.6, canvas.height * 0.8);
        ctx.stroke();

        // Draw Powerups
        state.powerups.forEach(p => {
            ctx.save();
            ctx.translate(p.x + p.size/2, p.y + p.size/2);
            ctx.rotate(p.angle);
            
            let color = '#fff';
            let icon = '?';
            if (p.type === 'FIRE') { color = '#ef4444'; icon = 'ðŸ”¥'; }
            if (p.type === 'FAST') { color = '#3b82f6'; icon = 'âš¡'; }
            if (p.type === 'BIG')  { color = '#facc15'; icon = 'â¬†'; }
            if (p.type === 'SHRINK') { color = '#a855f7'; icon = 'â˜ ï¸'; }
            if (p.type === 'FREEZE') { color = '#22d3ee'; icon = 'â„ï¸'; }

            // Glow
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;
            ctx.fillStyle = color;
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            
            // Icon
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#000';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icon, 0, 0);

            ctx.restore();
        });

        // Paddles
        // Player
        ctx.fillStyle = player.color;
        ctx.shadowColor = player.color;
        ctx.shadowBlur = 10;
        ctx.fillRect(player.x, player.y, player.w, player.h);

        // AI
        ctx.fillStyle = ai.color;
        ctx.shadowColor = ai.color;
        ctx.fillRect(ai.x, ai.y, ai.w, ai.h);
        ctx.shadowBlur = 0;

        // Frozen Effect Overlays
        if (state.activeEffect?.type === 'FREEZE') {
            const t = state.activeEffect.target === 'player' ? player : ai;
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(t.x-2, t.y-2, t.w+4, t.h+4);
        }

        // Ball
        ctx.beginPath();
        if (ball.isFire) {
            ctx.fillStyle = '#ff4500';
            ctx.shadowColor = 'orange';
            ctx.shadowBlur = 20;
        } else {
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 5;
        }
        ctx.arc(ball.x + CONSTANTS.BALL_SIZE/2, ball.y + CONSTANTS.BALL_SIZE/2, CONSTANTS.BALL_SIZE/2, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Particles
        state.particles.forEach((p, i) => {
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.02;
            if(p.life <= 0) state.particles.splice(i, 1);
            
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1;
        });

        ctx.restore();
    }

    function createParticles(x, y, color, count) {
        for(let i=0; i<count; i++) {
            state.particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5)*12,
                vy: (Math.random()-0.5)*12,
                color: color,
                life: 1.0
            });
        }
    }

    function gameLoop() {
        if(state.screen === 'PLAYING') {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    }

    // Initial Render
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0,0,canvas.width, canvas.height);

</script>
</body>
</html>